# REST API Plan

## 1. Resources

- **Users** - User accounts (maps to `users` table)
- **Flashcards** - Educational flashcards created by users (maps to `flashcards` table)
- **Flashcard Candidates** - Temporary flashcards generated by AI before approval
- **Flashcard Reviews** - Review history and spaced repetition data (maps to `flashcard_reviews` table)
- **Study Sessions** - User study sessions (maps to `study_sessions` table)
- **Session Reviews** - Links between sessions and reviews (maps to `session_reviews` table)

## 2. Endpoints

### Authentication

Authentication is handled by Supabase Auth service. The frontend will interact directly with Supabase for:
- Registration
- Login/Logout
- Password reset
- Session management

### Flashcards

#### GET /api/flashcards
- **Description**: Retrieve user's flashcards with optional filtering
- **Query Parameters**:
  - `page` (integer): Page number for pagination
  - `limit` (integer): Number of items per page (default: 20, max: 100)
  - `sort` (string): Sort field (created_at, updated_at)
  - `order` (string): Sort order (asc, desc)
  - `source` (string): Filter by source (manual, ai, semi_ai)
- **Response**:
  ```json
  {
    "data": [
      {
        "id": "uuid",
        "front_content": "string",
        "back_content": "string",
        "source": "string",
        "ai_metadata": "object|null",
        "created_at": "string",
        "updated_at": "string"
      }
    ],
    "pagination": {
      "total": "integer",
      "page": "integer",
      "limit": "integer",
      "pages": "integer"
    }
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

#### GET /api/flashcards/:id
- **Description**: Retrieve a specific flashcard
- **Response**:
  ```json
  {
    "id": "uuid",
    "front_content": "string",
    "back_content": "string",
    "source": "string",
    "ai_metadata": "object|null",
    "created_at": "string",
    "updated_at": "string"
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Flashcard not found
  - 500 Internal Server Error

#### POST /api/flashcards
- **Description**: Create a new flashcard
- **Request**:
  ```json
  {
    "front_content": "string",
    "back_content": "string"
  }
  ```
- **Response**:
  ```json
  {
    "id": "uuid",
    "front_content": "string",
    "back_content": "string",
    "source": "manual",
    "ai_metadata": null,
    "created_at": "string",
    "updated_at": "string"
  }
  ```
- **Success**: 201 Created
- **Errors**:
  - 400 Bad Request: Invalid input data
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

#### PUT /api/flashcards/:id
- **Description**: Update an existing flashcard
- **Request**:
  ```json
  {
    "front_content": "string",
    "back_content": "string"
  }
  ```
- **Response**:
  ```json
  {
    "id": "uuid",
    "front_content": "string",
    "back_content": "string",
    "source": "string", // Will change to 'semi_ai' if editing an AI-generated flashcard
    "ai_metadata": "object|null",
    "created_at": "string",
    "updated_at": "string"
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 400 Bad Request: Invalid input data
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Flashcard not found
  - 500 Internal Server Error

#### DELETE /api/flashcards/:id
- **Description**: Delete a flashcard
- **Success**: 204 No Content
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Flashcard not found
  - 500 Internal Server Error

### Flashcard Candidates (AI Generation)

#### POST /api/flashcards/generate
- **Description**: Generate flashcard candidates using AI
- **Request**:
  ```json
  {
    "source_text": "string",
    "options": {
      "max_flashcards": "integer" // Optional, default: 10
    }
  }
  ```
- **Response**:
  ```json
  {
    "flashcards_proposals": [
      {
        "front_content": "string",
        "back_content": "string",
        "ai_metadata": {
          "model": "string",
          "generation_time": "string",
          "parameters": "object"
        }
      }
    ]
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 400 Bad Request: Invalid input (e.g., text too short)
  - 401 Unauthorized: User not authenticated
  - 429 Too Many Requests: Rate limit exceeded
  - 500 Internal Server Error

#### POST /api/flashcards/
- **Description**: Approve and save flashcards
- **Request**:
  ```json
  {
    "flashcards": [
      {
        "front_content": "string", // Can be modified from original
        "back_content": "string",  // Can be modified from original
        "ai_metadata": "object"
      }
    ]
  }
  ```
- **Response**:
  ```json
  {
    "approved": [
      {
        "id": "uuid", // Permanent database ID
        "front_content": "string",
        "back_content": "string",
        "source": "ai", // or "semi_ai" if modified
        "ai_metadata": "object",
        "created_at": "string",
        "updated_at": "string"
      }
    ],
    "count": "integer"
  }
  ```
- **Success**: 201 Created
- **Errors**:
  - 400 Bad Request: Invalid input data
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

### Study Sessions

#### POST /api/study-sessions
- **Description**: Start a new study session
- **Response**:
  ```json
  {
    "id": "uuid",
    "start_time": "string",
    "end_time": null,
    "cards_reviewed": 0,
    "created_at": "string"
  }
  ```
- **Success**: 201 Created
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

#### GET /api/study-sessions
- **Description**: Get user's study session history
- **Query Parameters**:
  - `page` (integer): Page number
  - `limit` (integer): Items per page
  - `from_date` (string): Filter by start date
  - `to_date` (string): Filter by end date
- **Response**:
  ```json
  {
    "data": [
      {
        "id": "uuid",
        "start_time": "string",
        "end_time": "string|null",
        "cards_reviewed": "integer",
        "created_at": "string"
      }
    ],
    "pagination": {
      "total": "integer",
      "page": "integer",
      "limit": "integer",
      "pages": "integer"
    }
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

#### GET /api/study-sessions/:id
- **Description**: Get details of a specific study session
- **Response**:
  ```json
  {
    "id": "uuid",
    "start_time": "string",
    "end_time": "string|null",
    "cards_reviewed": "integer",
    "created_at": "string",
    "reviews": [
      {
        "flashcard_id": "uuid",
        "front_content": "string",
        "back_content": "string",
        "quality_response": "integer",
        "reviewed_at": "string"
      }
    ]
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Study session not found
  - 500 Internal Server Error

#### PUT /api/study-sessions/:id
- **Description**: Update a study session (typically to end it)
- **Request**:
  ```json
  {
    "end_time": "string"
  }
  ```
- **Response**:
  ```json
  {
    "id": "uuid",
    "start_time": "string",
    "end_time": "string",
    "cards_reviewed": "integer",
    "created_at": "string"
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 400 Bad Request: Invalid input data
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Study session not found
  - 500 Internal Server Error

#### GET /api/study-sessions/:id/next-flashcard
- **Description**: Get the next flashcard to review in a study session
- **Response**:
  ```json
  {
    "flashcard": {
      "id": "uuid",
      "front_content": "string",
      "back_content": "string"
    },
    "is_last": "boolean"
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Study session not found or no more flashcards
  - 500 Internal Server Error

### Flashcard Reviews

#### POST /api/flashcard-reviews
- **Description**: Submit a flashcard review during a study session
- **Request**:
  ```json
  {
    "study_session_id": "uuid",
    "flashcard_id": "uuid",
    "quality_response": "integer" // 0-5 according to SM-2 algorithm
  }
  ```
- **Response**:
  ```json
  {
    "id": "uuid",
    "flashcard_id": "uuid",
    "quality_response": "integer",
    "easiness_factor": "number",
    "interval": "integer",
    "repetitions": "integer",
    "next_review_date": "string",
    "reviewed_at": "string"
  }
  ```
- **Success**: 201 Created
- **Errors**:
  - 400 Bad Request: Invalid input data
  - 401 Unauthorized: User not authenticated
  - 404 Not Found: Flashcard or study session not found
  - 500 Internal Server Error

#### GET /api/flashcard-reviews
- **Description**: Get review history for flashcards
- **Query Parameters**:
  - `flashcard_id` (uuid): Filter by flashcard
  - `page` (integer): Page number
  - `limit` (integer): Items per page
- **Response**:
  ```json
  {
    "data": [
      {
        "id": "uuid",
        "flashcard_id": "uuid",
        "quality_response": "integer",
        "easiness_factor": "number",
        "interval": "integer",
        "repetitions": "integer",
        "next_review_date": "string",
        "reviewed_at": "string"
      }
    ],
    "pagination": {
      "total": "integer",
      "page": "integer",
      "limit": "integer",
      "pages": "integer"
    }
  }
  ```
- **Success**: 200 OK
- **Errors**:
  - 401 Unauthorized: User not authenticated
  - 500 Internal Server Error

## 3. Authentication and Authorization

The application uses Supabase Auth for authentication, which provides:

- Email/password authentication
- OAuth providers (if needed in the future)
- JWT token-based authentication
- Refresh token rotation

Authorization is enforced through:

1. **API Level**: JWT validation for all endpoints
2. **Database Level**: Row Level Security (RLS) policies in PostgreSQL:
   - Users can only access their own data
   - All tables have appropriate RLS policies

Implementation details:
- Frontend will use Supabase client library to handle authentication
- API will validate JWT tokens and map to user IDs
- Database RLS policies ensure users can only access their own data even if API validation is bypassed

## 4. Validation and Business Logic

### Validation Rules

1. **Users**
   - Email must match regex: `^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$`

2. **Flashcards**
   - `front_content` and `back_content` maximum length: 200 characters
   - `source` must be one of: 'manual', 'ai', 'semi_ai'
   - If `source` is 'ai' or 'semi_ai', `ai_metadata` must not be null

3. **Flashcard Reviews**
   - `quality_response` must be between 0 and 5
   - `easiness_factor` must be >= 1.3

### Business Logic Implementation

1. **AI Flashcard Generation**
   - Input text validation (minimum length)
   - Call to external AI service via Openrouter.ai
   - Processing and formatting AI response into candidate flashcards
   - Temporary storage of candidates until approval

2. **Flashcard Source Tracking**
   - New flashcards created manually get source='manual'
   - New flashcards approved from AI get source='ai'
   - When editing AI-generated flashcards, source changes to 'semi_ai'

3. **SM-2 Spaced Repetition Algorithm**
   - Implemented in POST /api/flashcard-reviews endpoint
   - Calculates new values for:
     - `easiness_factor`
     - `interval`
     - `repetitions`
     - `next_review_date`
   - Updates flashcard review history

4. **Study Session Management**
   - Automatically tracks `cards_reviewed` count
   - Provides next flashcards due for review
   - Links flashcard reviews to study sessions 